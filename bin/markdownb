#!node
// Converts a markdown file into an HTML file, writing it to stdout.
//
// Usage:
//   node markdown <filename> <flavor> <stylesheet> <github user id>
//
var markdown = require('../lib/markdown');
var opts = require('../lib/getopts')();
console.log('>>>opts=', opts);
var fileName = opts._[0];
var stylesheet = opts.stylesheet;
var fs = require('fs');
var tmp = require('tmp');
var spawn = require('child_process').spawn;
var open = require('open');
var path = require('path');

tmp.file({prefix: 'markdown-', postfix: '.html'}, function(err, tmpPath, fd, cleanupCB) {
  if (err) {
    console.log('>>>error: ' + err);
    process.exit();
  }
  var cssfullpath;
  if (stylesheet) {
    try {
      var csscontent = fs.readFileSync(stylesheet);
      dirname = path.dirname(tmpPath);
      try {
        var cssdir = path.dirname(stylesheet);
        var cssbasename = path.basename(stylesheet);
        var cssdirpath = path.join(dirname, cssdir);
        if (cssdir && ! fs.existsSync(cssdirpath)) fs.mkdirSync(cssdirpath);
        cssfullpath = path.join(cssdirpath, cssbasename);
        fs.writeFileSync(cssfullpath, csscontent);
      } catch(err) {
        console.error('>>>Could not write temp stylesheet: ' + err);
        process.exit();
      }
    } catch(err) {
      console.error('>>>stylesheet file not found.');
      process.exit();
    }
  }
  console.log('tmp path="' + tmpPath);
  var out = fs.createWriteStream(null, {fd: fd});
  child = spawn('node', ['./bin/markdown', fileName,
             (opts.flavor) ? ' -f ' : '',  (opts.flavor) ? opts.flavor : '',
             (opts.highlight) ? ' -h' : '',
             (stylesheet) ? ' -s ' : '', (stylesheet) ? stylesheet : '',
             (opts.context) ? ' -c ' : '', (opts.context) ? opts.context : '']);
  child.stdout.pipe(out);
  child.stderr.pipe(out);
  child.on('close', function(code) {
    open(tmpPath);
    console.log('View generated HTML in browser');
    setTimeout(function() {
      if(cssfullpath) fs.unlinkSync(cssfullpath);
      console.log('Temporary files deleted');
    }, 10000);
  });
});
